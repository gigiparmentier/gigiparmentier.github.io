<!DOCTYPE HTML>
<html>

  <head>
    <title>Attestation</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="moment.min.js"></script>
    <script src="https://parall.ax/parallax/js/jspdf.js"></script>
    <link rel="stylesheet" href="style.css">
  </head>

  <body>
    <p>Personne :</p>
    <select id='prenom_select'>
    </select>
    <p>Date de sortie :</p>
    <input type="date" id="date">
    <p>Heure de sortie :</p>
    <input type="time" id="heure">
    <p>Motif de sortie :</p>
    <select id='motif_select'>
    </select>
    <button onclick="generate_pdf()">Générer Attestation</button>
    <canvas id="canvas1" width="1529" height="2164"></canvas>
    <canvas id="canvas2" width="1529" height="2164"></canvas>
    <script>
      motifs = ["travail","achats_culturel","sante","famille","handicap","sport_animaux","convocation","missions","enfants"];
      motifXs = [89.25, 114.82, 132.15, 140.9, 154,162.7,188.9,197.6,206.3];
      motifs_desc = ['Travail', 'Courses', 'Santé', 'Famille', 'Handicap','Sport/Chien','Convocation','Missions','Enfants'];
      prenoms = ['tristan boin', 'faustine boin', 'younn boin', 'dominique boin', 'manon boin', 'tanguy boin','mathis coggiola'];
      dates_naissances = ['05/12/1997', '27/12/1999', '17/12/2001', '06/10/1967', '29/02/1992', '14/05/1695','01/09/1998'];
      adresses = ['138 Boulevard de Sévigné 35700 Rennes','138 Boulevard de Sévigné 35700 Rennes','138 Boulevard de Sévigné 35700 Rennes','138 Boulevard de Sévigné 35700 Rennes','Guérande','138 Boulevard de Sévigné 35700 Rennes','27 rue cardinale, 13100, Aix-en-Provence'];

      for (prenom in prenoms) {
        prenom = prenoms[prenom];
        option = document.createElement('option');
        option.value = prenom;
        option.innerHTML = prenom.charAt(0).toUpperCase() + prenom.slice(1).split(' ')[0];
        document.getElementById('prenom_select').appendChild(option);
      }

      for (motif in motifs) {
        motif_desc = motifs_desc[motif];
        motif = motifs[motif];
        option = document.createElement('option');
        option.value = motif;
        option.innerHTML = motif_desc;
        document.getElementById('motif_select').appendChild(option);
      }

      document.getElementById('date').value = moment().format('YYYY-MM-DD');
      document.getElementById('date').min = moment().format('YYYY-MM-DD');
      document.getElementById('heure').value = moment(Date.now()).subtract(5, 'm').format('HH:mm');

      if (document.cookie.length > 0){
        generate_pdf();
      }

      function generate_qr_code(size) {
        if (document.cookie.length > 0 && false){
          cookies = document.cookie.split(';');
          prenom = cookies[0].split('=')[1];
          date_naissance = cookies[1].split('=')[1];
          adresse = cookies[2].split('=')[1];
          ville = cookies[3].split('=')[1];
        }
        else{
          prenom = document.getElementById('prenom_select').value;
          date_naissance = dates_naissances[prenoms.indexOf(prenom)];
          adresse = adresses[prenoms.indexOf(prenom)];
          ville = adresse.split(' ')[adresse.split(' ').length - 1];
        }
        date = moment().format('DD/MM/YYYY');
        heure = moment(Date.now()).subtract(5, 'm').format('HH') + 'h' + moment(Date.now()).subtract(5, 'm').format('mm');
        date_sortie = document.getElementById('date').value.replace('-','/');
        heure_sortie = document.getElementById('heure').value;
        queries = new URLSearchParams(window.location.search);
        if (queries.get('motif') != undefined){
          motif = queries.get('motif');
        }
        else{
          motif = document.getElementById('motif_select').value;
        }
        url = "https://api.qrserver.com/v1/create-qr-code/?size=" + size + "x" + size + "&ecc=Q&data=Cree le: " + date + " a " + heure + ";%0A Nom: " + prenom.split(' ')[1] + ";%0A Prenom: " + prenom.split(' ')[0] + ";%0A Naissance: " + date_naissance +
            " a rennes;%0A Adresse: " + adresse + ";%0A Sortie: " + date + " a " + heure_sortie + ";%0A Motifs: " + motif;
        if (document.cookie.length == 0){
          document.cookie = "prenom="+prenom+";expires=Thu, 31 Dec 2020 12:00:00 UTC";
          document.cookie = "date_naissance="+date_naissance+";expires=Thu, 31 Dec 2020 12:00:00 UTC";
          document.cookie = "adresse="+adresse+";expires=Thu, 31 Dec 2020 12:00:00 UTC";
          document.cookie = "ville="+ville+";expires=Thu, 31 Dec 2020 12:00:00 UTC";
        }
        return url;
      }

      function generate_pdf() {
        pdf = new jsPDF();
        qr = generate_qr_code(500);
        getDataUri('att.png', function(dataUri) {
          pdf.addImage(dataUri, 0, 0, 210, 279);
          pdf.addFont('Helvetica', 'Helvetica', 'bold');
          pdf.setFont('Helvetica');
          pdf.setFontSize(12);
          pdf.text(prenom, 26.2, 35.5);
          pdf.text(date_naissance, 24.4, 42);
          pdf.text(ville, 71.6, 42);
          pdf.text(adresse, 28.8, 48.4);
          pdf.text(ville, 19, 260.5);
          pdf.text(date, 12.9, 267.2);
          pdf.text(heure.replace('h', ':'), 76.8, 267.2);

          pdf.setFontSize(12);
          pdf.text('X', 5.9, motifXs[motifs.indexOf(motif)]);
          getDataUri(qr, function(dataUri) {
            pdf.addImage(dataUri, 160.7, 246, 35, 35);
            pdf.addPage();
            getDataUri(qr, function(dataUri) {
              pdf.addImage(dataUri, 18, 18, 95, 95);
              //pdf.output('dataurlnewwindow');
              pdf.save("attestation-"+moment().format('HH:mm:ss')+".pdf")
            });
          });
        });
      }

      function getDataUri(url, cb) {
        var image = new Image();
        image.setAttribute('crossOrigin', 'anonymous');
        image.onload = function() {
          var canvas = document.createElement('canvas');
          canvas.width = this.naturalWidth;
          canvas.height = this.naturalHeight;
          var ctx = canvas.getContext('2d');
          ctx.fillStyle = '#fff';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          canvas.getContext('2d').drawImage(this, 0, 0);
          cb(canvas.toDataURL('image/jpeg'));
        };
        image.src = url;
      }
    </script>
  </body>

</html>
